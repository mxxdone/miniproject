name: Deploy Backend to EC2

on:
  push:
    branches: [ main ] # main 브랜치에 Push될 때 실행
    paths:
      - 'backend/**'  # backend/ 디렉터리 내부 파일 변경 시에만 실행
      - 'docker-compose.yml' # Docker Compose 파일 변경 시에도 실행
      - '.github/workflows/backend-deploy.yml' # 이 워크플로우 파일 변경 시에도 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 작업이 실행될 가상 환경

    steps:
      # 1. GitHub 레포지토리의 코드를 가상 환경으로 가져옵니다.
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. EC2에 배포할 디렉토리 준비
      - name: Prepare Deployment Directory on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_DIR="/home/ec2-user/miniproject"
            
            # 기존 작업 디렉토리 삭제 및 재생성
            rm -rf $DEPLOY_DIR
            mkdir -p $DEPLOY_DIR

      # 3. (변경) Docker Compose 빌드에 필요한 모든 파일을 EC2로 전송합니다.
      - name: Copy All Project Files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          # Docker Compose 빌드에 필요한 모든 파일 (루트 포함)을 EC2의 새 디렉토리로 전송합니다.
          source: "./*"
          target: "/home/ec2-user/miniproject"

      # 7. EC2에 접속하여 Spring Boot 실행에 필요한 환경 변수(.env) 파일을 생성합니다.
      - name: Create environment file on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "Creating /home/ec2-user/miniproject.env file..."
            # GitHub Secrets에 등록한 모든 런타임 비밀 값을 .env 파일로 덮어씁니다.
            cat <<EOF > /home/ec2-user/miniproject.env
            # RDS 접속 URL
            SPRING_DATASOURCE_URL=jdbc:postgresql://my-project-db.cv0468m20ioy.ap-northeast-2.rds.amazonaws.com:5432/miniproject
            # RDS
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            # App
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            # JWT
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            # AWS S3 (for Image Upload)
            SPRING_CLOUD_AWS_CREDENTIALS_ACCESS_KEY=${{ secrets.SPRING_CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}
            SPRING_CLOUD_AWS_CREDENTIALS_SECRET_KEY=${{ secrets.SPRING_CLOUD_AWS_CREDENTIALS_SECRET_KEY }}
            # OAuth2
            SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID=${{ secrets.SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID }}
            SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET=${{ secrets.SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET }}
            SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE=${{ secrets.SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE }}
            EOF

      # 5. EC2에 접속하여 Docker Compose로 애플리케이션을 빌드 및 배포합니다.
      - name: Deploy with Docker Compose on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_DIR="/home/ec2-user/miniproject"
            
            # 1. 작업 디렉토리로 이동
            cd $DEPLOY_DIR
            
            # 2. gradlew 실행 권한 부여 (컨테이너 빌드 시 필요)
            chmod +x gradlew || true
            
            # 3. Docker Compose 빌드 및 실행
            docker compose up -d --build --force-recreate
            
            echo "--- Docker Compose Deployment Complete ---"
